<!DOCTYPE html>
<html lang="zxx" class="no-js">

<head>
    <!-- Mobile Specific Meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Favicon-->
    <link rel="shortcut icon" href="img/fav.png">
    <!-- Author Meta -->
    <meta name="author" content="CodePixar">
    <!-- Meta Description -->
    <meta name="description" content="">
    <!-- Meta Keyword -->
    <meta name="keywords" content="">
    <!-- meta character set -->
    <meta charset="UTF-8">
    <!-- Site Title -->
    <title>Karma Shop</title>

    <!--
            CSS
            ============================================= -->
    <link rel="stylesheet" href="../fe/css/linearicons.css">
    <link rel="stylesheet" href="../fe/css/owl.carousel.css">
    <link rel="stylesheet" href="../fe/css/themify-icons.css">
    <link rel="stylesheet" href="../fe/css/font-awesome.min.css">
    <link rel="stylesheet" href="../fe/css/nice-select.css">
    <link rel="stylesheet" href="../fe/css/nouislider.min.css">
    <link rel="stylesheet" href="../fe/css/bootstrap.css">
    <link rel="stylesheet" href="../fe/css/main.css">
    <script src="sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>





    <style>
        .list li a {
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            vertical-align: middle;
        }
    </style>
    <style>
        /* popup------------------------------------------------- */
        .overlay-pop-up {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            opacity: 0.5;
            z-index: 99;
        }

        .pop-up-button {
            position: absolute;
            top: 0;
            right: 0;
            padding: 35px;
            outline: none;
            border: none;
            background-color: #e47312;
            transition: all 300ms ease;
            color: #fff;
            font-size: 22px;
            font-weight: 100;
            text-transform: uppercase;
            cursor: pointer;
        }

        .pop-up-list {
            box-sizing: border-box;
            position: fixed;
            top: 0;
            right: 0;
            width: 500px;
            height: 100%;
            z-index: 10000;
            padding: 95px 50px 35px 70px;
            background-color: #fff;
            color: black;
            transition: all 0.2s ease-out;
            display: none;
        }

        .list-wrapper {
            margin-top: 80px;
        }

        /* popup ends------------------------------ */

        .info-wrapper:hover {
            background-color: #e98a38;
            color: white;
        }

        .button {
            margin-top: 0x;
            min-width: 160px;
            padding: 15px 25px;
            transition: all 300ms ease;
            color: #fff;
            font-weight: 500;
            text-align: center;
            letter-spacing: 1px;
            background-color: #e47312;
            border: 0;
            cursor: pointer;
        }

        .button:hover {
            background-color: #e98a38;
        }

        .change {

            padding: 10px 20px;
            transition: all 300ms ease;
            color: #fff;
            font-weight: 500;
            text-align: center;
            letter-spacing: 1px;
            background-color: #e47312;
            border: 0;
            cursor: pointer;
        }

        .change:hover {
            background-color: #e98a38;
        }


        .top-title-section {
            box-sizing: border-box;
            width: 100%;
            height: 60px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .top-title.special {
            z-index: 2;
            position: relative;
            color: black;
            margin: 0;
            font-size: 40px;
            line-height: 50px;
            letter-spacing: 1px;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <!-- Start Header Area -->
    <%- include('../layouts/userHeader.ejs')%>
        <!-- End Header Area -->



        <!--================Checkout Area =================-->
        <section class="checkout_area section_gap" style="margin-top: 100px;">

            <form action="/confirmOrder" method="post" id="checkOut-form">
                <div class="container">
                    <!-- 
                    <div class="cupon_area" style="margin-top: 60px;">
                        <input type="text" placeholder="Enter coupon code">
                        <a class="tp_btn" href="#">Apply Coupon</a>
                    </div> -->


                    <div class="billing_details" style="margin-top: 0px;">
                        <div class="row">
                            <div class="col-lg-8">
                               <h3>Shipping Details</h3>

                                         <% if (addArray.length > 0) { %>

                                            <input type="hidden" placeholder="Name" class="form-control" id="first"
                                                name="addressId" value="<%=addArray[0]._id%>">


                                            <div class="col-md-6 form-group p_star">

                                                <input type="text" placeholder="Name" class="form-control" id="first"
                                                    name="name" value="<%=addArray[0].name%>">

                                            </div>


                                            <div class="col-md-6 form-group p_star">
                                                <input type="text" placeholder="Phone number" class="form-control"
                                                    id="number" name="number" value="<%=addArray[0].mobileNumber%>">
                                            </div>


                                            <div class="col-md-12 form-group p_star">
                                                <input type="text" placeholder="Address line " class="form-control"
                                                    id="add1" name="add1" value="<%=addArray[0].address%>">
                                            </div>
                                            <div class="col-md-12 form-group p_star">
                                                <input type="text" placeholder="Locality" class="form-control" id="add2"
                                                    name="add2" value="<%=addArray[0].locality%>">
                                            </div>
                                            <div class="col-md-12 form-group p_star">
                                                <input type="text" placeholder="City" class="form-control" id="city"
                                                    name="city" value="<%=addArray[0].city%>">
                                            </div>
                                            <div class="col-md-12 form-group p_star">
                                                <input type="text" placeholder="State" class="form-control" id="city"
                                                    name="city" value="<%=addArray[0].state%>">

                                            </div>
                                            <div class="col-md-12 form-group">
                                                <input type="text" class="form-control" id="zip" name="zip"
                                                    placeholder="Postcode/ZIP" value="<%=addArray[0].pincode%>">
                                            </div>
                                            <div class="banner-desc"
                                                style="margin-left: 15px; margin-top:15px; margin-bottom: 30px;margin-top: 40px; ">
                                                <a class="button" style="color: #fff; border-radius: 20px;">CHANGE
                                                    ADDRESS</a>
                                            </div>

                                         

                                            <div class="banner-desc2"
                                                style="margin-left: 15px; margin-top:15px; margin-bottom: 30px; ">
                                                <a class="button" style="color: #fff; border-radius: 20px;">ADD
                                                    ADDRESS</a>
                                            </div>

                                     

                                                <div class="col-md-12 form-group" style="display: none;">
                                                    <div class="creat_account">
                                                        <h3>Shipping Details</h3>
                                                        <input type="checkbox" id="f-option3" name="selector">
                                                        <label for="f-option3">Ship to a different address?</label>
                                                    </div>

                                                    <textarea class="form-control" name="message" id="message" rows="1"
                                                        placeholder="Order Notes"></textarea>
                                                </div>

                                                <% } else { %>
                                                    <!-- Add Address button when addArray is empty -->
                                                    <div class="banner-desc2" style="margin-left: 15px; margin-top: 15px; margin-bottom: 30px;">
                                                        <a class="button" id="addAddressBtn" style="color: #fff; border-radius: 20px;">ADD ADDRESS</a>
                                                    </div>
                                                <% } %>
                                </form>
                            </div>
                            <div class="col-lg-4 col-md-6">
                                <div class="order_box">
                                    <h2>Your Order</h2>
                                    <div class="table-responsive">
                                        <table class="order_table">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Quantity</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% cart.cartItems.forEach((item)=> { %>
                                                    <tr>
                                                        <td>
                                                            <a href="#" title="<%= item.name %>">
                                                                <%= item.name %>
                                                            </a>
                                                        </td>
                                                        <td>
                                                            <span class="middle">
                                                                <%= item.quantity %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="last">
                                                                ₹<%= item.total %>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                    <ul class="list list_2">
                                        <li><a href="#">Subtotal <span>₹<%= cart.subTotal %></span></a></li>
                                        <!-- <li><a href="#">Shipping <span>Flat rate: ₹50.00</span></a></li> -->
                                        <li><a href="#">Discount <span id="couponOffer"></span></a></li>
                                        <li><a href="#">Total <span id="total">₹<%= cart.subTotal %></span></a></li>

                                        <input type="hidden" name="discountPercentage" id="discountPercentage"
                                            value="0">
                                        <input type="hidden" name="discountAmount" id="discountAmount" value="0">
                                        <input type="hidden" name="total" value="<%= cart.subTotal%>" id="totalVal">
                                       
                                    </ul>
                                 

                                    <div class="payment_item">
                                        <div>
                                            <input type="text" id="couponCode" placeholder="Enter Coupon Code"
                                                name="couponCode" style="margin-bottom: 10px;"><br>
                                            <button style="border: none;border-radius: 2px;color: white;background-color: #53ca5b;" onclick="applyCoupon('<%= cart.subTotal %>')">Apply</button>
                                            <button type="button"  style="border: none;border-radius: 2px;color: white;background-color: #ff4444;" onclick="clearCoupon()">Clear Coupon</button>
                                          
                                        </div>
                                        <span id="couponErr"></span>

                                    </div>
                                    <div class="payment_item">
                                        <div class="radion_btn">
                                            <input type="radio" id="f-option4" name="paymentOption" value="wallet" >
                                            <label for="f-option4">Wallet</label>
                                            <div class="check"></div>
                                        </div>
                                        <p>Pay  amount from your wallet  <br> Available Balance is <%=user.wallet%> </p>
                                    

                                    </div>
        
                                    <div class="payment_item">
                                        <div class="radion_btn">
                                            <input type="radio" checked id="f-option5" name="paymentOption" value="cod">
                                            <label for="f-option5">Cash On Delivery</label>
                                            <div class="check"></div>
                                        </div>
                                        <p>Pay the amount at your doorstep</p>
                                    </div>
                                    <div class="payment_item active">
                                        <div class="radion_btn">
                                            <input type="radio" id="f-option6" name="paymentOption" value="razorpay">
                                            <label for="f-option6">Razorpay </label>
                                            <img src="../user-asset/img/product/card.jpg" alt="">
                                            <div class="check"></div>
                                        </div>
                                        <p>Pay via Razorpay ; you can pay with your credit card if you don’t have a
                                            Razorpay
                                            account.</p>
                                    </div>

                                    <div class="creat_account">
                                        <!-- Rest of the code for the creat_account section -->
                                    </div>
                                    <button class="primary-btn" onclick=" proceedToPayment()" href="#">Confirm
                                        Order</button>
                                </div>
                            </div>



                        </div>
                    </div>
                </div>

            </form>

        </section>
        <!--================End Checkout Area =================-->

        <!-- start footer Area -->
        <footer class="footer-area section_gap">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3  col-md-6 col-sm-6">
                        <div class="single-footer-widget">
                            <h6>About Us</h6>
                            <p>
                                Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor
                                incididunt
                                ut labore dolore
                                magna aliqua.
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-4  col-md-6 col-sm-6">
                        <div class="single-footer-widget">
                            <h6>Newsletter</h6>
                            <p>Stay update with our latest</p>
                            <div class="" id="mc_embed_signup">

                                <form target="_blank" novalidate="true"
                                    action="https://spondonit.us12.list-manage.com/subscribe/post?u=1462626880ade1ac87bd9c93a&amp;id=92a4423d01"
                                    method="get" class="form-inline">

                                    <div class="d-flex flex-row">

                                        <input class="form-control" name="EMAIL" placeholder="Enter Email"
                                            onfocus="this.placeholder = ''" onblur="this.placeholder = 'Enter Email '"
                                            required="" type="email">


                                        <button class="click-btn btn btn-default"><i class="fa fa-long-arrow-right"
                                                aria-hidden="true"></i></button>
                                        <div style="position: absolute; left: -5000px;">
                                            <input name="b_36c4fd991d266f23781ded980_aefe40901a" tabindex="-1" value=""
                                                type="text">
                                        </div>

                                        <!-- <div class="col-lg-4 col-md-4">
													<button class="bb-btn btn"><span class="lnr lnr-arrow-right"></span></button>
												</div>  -->
                                    </div>
                                    <div class="info"></div>
                                </form>
                            </div>
                        </div>
                    </div>
                
                    <div class="col-lg-2 col-md-6 col-sm-6">
                        <div class="single-footer-widget">
                            <h6>Follow Us</h6>
                            <p>Let us be social</p>
                            <div class="footer-social d-flex align-items-center">
                                <a href="#"><i class="fa fa-facebook"></i></a>
                                <a href="#"><i class="fa fa-twitter"></i></a>
                                <a href="#"><i class="fa fa-dribbble"></i></a>
                                <a href="#"><i class="fa fa-behance"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
              
            </div>



            <div class="pop-up-list">
                <button class="pop-up-button"><i class="fa fa-times" aria-hidden="true"></i>
                </button>
                <div class="top-title-section">
                    <p class="top-title special">Addresses</p>
                </div>
                <br>
                <div class="comment-list grid-view" style="height: 400px; overflow-y: scroll;">
                    <% if (addArray.length===0) { %>
                        <h4>Change Address</h4>
                        <% } else { %>
                            <form id="addressForm" action="/checkout" method="POST">
                                <% addArray.forEach(function(address, index) { %>
                                    <label for="address{{@index}}">Address</label>
                                    <input type="radio" id="addressRadio{<%=index%>" name="addressRadio"
                                        value="<%=address._id%>" onchange="this.form.submit()">
                                    <br>
                                    <div class="single-comment grid-item">
                                        <div class="user justify-content-between d-flex">
                                            <div class="desc">
                                                <h5>Name: <%=address.name%>
                                                </h5>
                                                <h5>Number: <%=address.mobileNumber%>
                                                </h5>
                                                <h5>Address: <%=address.address%>
                                                </h5>
                                                <h5>City: <%=address.city%>
                                                </h5>
                                                <h5>Street: <%=address.locality%>
                                                </h5>
                                                <h5>Pin: <%=address.pincode%>
                                                </h5>
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                    <% }) %>
                            </form>
                            <% } %>
                </div>

            </div>
            <div class="overlay-pop-up"></div>


            <!-- popup2 -->

            <div class="pop-up-list">
                <button class="pop-up-button"><i class="fa fa-times" aria-hidden="true"></i>
                </button>
                <div class="top-title-section">
                    <p class="top-title special" style="margin-left: 31px;"> Add Address</p>
                </div>
                <br>
                <div class="comment-list grid-view" style="height: 400px; ">
                    <form id="addressForm2" action="/submitAddressCheckOut" method="POST"
                        style="font-size: 15px; background-color: #ffffff; padding: 1px; display: grid; grid-template-columns: 85px 1fr; grid-gap: 13px;">
                        <label for="name">Name:</label>
                        <input type="text" name="name" id="name" required>

                        <label for="mobile">Mobile:</label>
                        <input type="text" name="mno" id="mobile"  required>

                        <label for="address">Address:</label>
                        <input type="text" name="address" id="address" required>

                        <label for="locality">Locality:</label>
                        <input type="text" name="locality" id="locality" required>

                        <label for="city">City:</label>
                        <input type="text" name="city" id="city" required>

                        <label for="pincode">Pincode:</label>
                        <input type="text" name="pincode" id="pincode" required>

                        <label for="state">State:</label>
                        <input type="text" name="state" id="state" required>

                        <button type="submit"
                            style="background-color: orange; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                    </form>



                    <div id="responseMessage"></div>
                </div>
            </div>
            <div class="overlay-pop-up"></div>



       




        </footer>
        <!-- End footer Area -->


        <script>
            function submitForm(addressId) {
                var form = document.getElementById('addressForm');
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'addressId';
                input.value = addressId;
                form.appendChild(input);
                form.submit();
            }
        </script>


        <script>

            function truncateStringByWords(str, numWords) {
                const words = str.split(' ');

                if (words.length <= numWords) {
                    return str;
                }

                const truncatedWords = words.slice(0, numWords);
                const truncatedString = truncatedWords.join(' ');

                return truncatedString + '...';
            }


        </script>



        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script>
            $(document).ready(function () {
                $('#addressForm2').submit(function (event) {
                    event.preventDefault(); // Prevent form submission
        
                    // Validate form fields
                    const name = $('#name').val().trim();
                    const mobile = $('#mobile').val().trim();
                    const pincode = $('#pincode').val().trim();
                    const city = $('#city').val().trim();
                    const state = $('#state').val().trim();
        
                    // Check if fields are empty
                    if (!name || !mobile || !pincode || !city || !state) {
                        $('#responseMessage').text('All fields are required.');
                        return;
                    }
        
                    // Check if name contains any numbers
                    if (/\d/.test(name)) {
                        $('#responseMessage').text('Name should not contain numbers.');
                        return;
                    }
        
                    // Check if mobile and pincode contain characters
                    if (!/^\+?\d+$/.test(mobile)) {
                        $('#responseMessage').text('Mobile should only contain numbers.');
                        return;
                    }
        
                    if (!/^\d+$/.test(pincode)) {
                        $('#responseMessage').text('Pincode should only contain numbers.');
                        return;
                    }
        
                    // Send AJAX request
                    $.ajax({
                        url: $(this).attr('action'),
                        type: $(this).attr('method'),
                        data: $(this).serialize(),
                        success: function (response) {
                            if (response.message === 'Address saved successfully!') {
                                // Display success message
                                $('#responseMessage').text('Address added successfully');
                                $('#addressForm2')[0].reset();
                                location.reload();
                            } else {
                                // Handle error or display appropriate message
                                $('#responseMessage').text('Failed to add address');
                            }
                        },
                        error: function () {
                            // Handle error or display appropriate message
                            $('#responseMessage').text('Failed to add address');
                        }
                    });
                });
            });
        </script>
        














        <script src="../fe/js/vendor/jquery-2.2.4.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
            integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
            crossorigin="anonymous"></script>
        <script src="../fe/js/vendor/bootstrap.min.js"></script>
        <script src="../fe/js/jquery.ajaxchimp.min.js"></script>
        <script src="../fe/js/jquery.nice-select.min.js"></script>
        <script src="../fe/js/jquery.sticky.js"></script>
        <script src="../fe/js/nouislider.min.js"></script>
        <script src="../fe/js/jquery.magnific-popup.min.js"></script>
        <script src="../fe/js/owl.carousel.min.js"></script>
        <!--gmaps Js-->
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjCGmQ0Uq4exrzdcL6rvxywDDOvfAu6eE"></script>
        <script src="../fe/js/gmaps.min.js"></script>
        <script src="../fe/js/main.js"></script>


        <script>


            var addAddressBtn = document.getElementById("addAddressBtn");


            // Get all popup elements and overlays
            var popups = document.querySelectorAll(".pop-up-list");
            var overlays = document.querySelectorAll(".overlay-pop-up");
            
            // Get all buttons and close buttons
            var buttons = document.querySelectorAll(".button");
            var closes = document.querySelectorAll(".pop-up-button");
            
            // Function to open popup and overlay
            function openPopup(popup, overlay) {
              popup.style.display = "block";
              overlay.style.display = "block";
            }
            
            // Function to close popup and overlay
            function closePopup(popup, overlay) {
              popup.style.display = "none";
              overlay.style.display = "none";
            }
            
            // Add event listeners to each button to open the respective popup
            buttons.forEach(function (button, index) {
              button.onclick = function () {
                openPopup(popups[index], overlays[index]);
              };
            });
            
            // Add event listeners to each overlay to close the respective popup
            overlays.forEach(function (overlay, index) {
              overlay.onclick = function () {
                closePopup(popups[index], overlay);
              };
            });
            
            // Add event listeners to each close button to close the respective popup
            closes.forEach(function (close, index) {
              close.onclick = function () {
                closePopup(popups[index], overlays[index]);
              };
            });


            // Function to open popup and overlay
            function openPopup(popup, overlay) {
                popup.style.display = "block";
                overlay.style.display = "block";
            }

            // Event listener for the "Add Address" button
            addAddressBtn.onclick = function () {
                // Open the existing popup when clicked
                openPopup(popups[1], overlays[1]);
            };
          </script>
          


        <script>
            function proceedToPayment() {
                event.preventDefault()
                $.ajax({
                    url: "/confirmOrder",
                    method: 'POST',
                    data: $('#checkOut-form').serialize(),
                    success: (response) => {
                        console.log(response, '+++++=========== ');
                        if (response.error) {
                            console.log(response, 'error--------------------------------');

                            console.log(response.error.message, '---------------');
                            Swal.fire({
                                title: 'Error!',
                                text: response.error,
                                icon: 'error',
                                timer: 5000
                            })
                        } else if (response.codStatus == true ||  response.orderStatus== true ) {
                            console.log("res" + response.codStatus)
                            console.log(response, 'status');
                            Swal.fire({
                                title: 'Order Placed!',
                                text: 'Your order has been placed successfully.',
                                icon: 'success',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'View Order',
                                cancelButtonText: 'Continue Shopping'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    location.href = '/orderSlip';
                                } else {
                                    location.href = '/home';
                                }
                            });

                        } else if (response.order.status === "created") {


                          
                            console.log(response.order);

                            rezorpayPayment(response.order)

                        }




                    }
                })
            }

            function rezorpayPayment(order) {

                console.log("here", order.amount);




                console.log("rezorpayPayment");


                var options = {


                    "key": "rzp_test_appNafjPDShFxm", // Enter the Key ID generated from the Dashboard
                    "amount": order.amount * 100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                    "currency": "INR",
                    "name": "Audiogalore",
                    "description": "Thank You",
                    "image": "https://example.com/your_logo",
                    "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                    "handler": function (response) {
                        // alert(response.razorpay_payment_id);
                        // alert(response.razorpay_order_id);
                        // alert(response.razorpay_signature)



                        verifyPayment(response, order)
                    },

                    "modal": {
                        "ondismiss": function() {
                            console.log('Payment window closed');
                            paymentFailed(order);
                        }
                        },





                    "prefill": {
                        "name": "Gaurav Kumar",
                        "email": "gaurav.kumar@example.com",
                        "contact": "9000090000"
                    },
                    "notes": {
                        "address": "Razorpay Corporate Office"
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };

                var rzp1 = new Razorpay(options);
                rzp1.on('payment.failed', function (response) {
                    alert(response.error.code);
                    alert(response.error.description);
                    alert(response.error.source);
                    alert(response.error.step);
                    alert(response.error.reason);
                    alert(response.error.metadata.order_id);
                    alert(response.error.metadata.payment_id);
                });
                rzp1.open();



            }


            function verifyPayment(payment, order) {

                console.log("iam here");
                $.ajax({
                    url: "/verifyPayment",
                    data: {
                        payment,
                        order
                    },
                    method: "post",
                    success: (response) => {

                        if (response.status) {
                            Swal.fire({
                                title: 'Order Placed!',
                                text: 'Your order has been placed successfully.',
                                icon: 'success',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'View Order',
                                cancelButtonText: 'Continue Shopping'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    location.href = '/orderSlip';
                                } else {
                                    location.href = '/home';
                                }
                            });
                        } else {
                            alert("payment failed")
                        }

                    }

                })
            }

        </script>



           <!-- payment failed -->

           <script>
            function paymentFailed(order) {
    $.ajax({
      url: 'paymentFailed',
      method: 'post',
      data: {
        order,
      },
       
      success: (response) => {
        if (response.status) {
          Swal.fire({
            title: 'Order Failed!',
            text: 'Your order is failed.',
            icon: 'error',
            timer: 5000
          }).then(() => {
            location.href = '/shop'
          })
        } else {

        }

      }
    })
  }
           </script>

           


        <!-- //coupon -->


        <script>
            function applyCoupon(total) {



                event.preventDefault(); // Prevent form submission
                let couponCode = document.getElementById('couponCode').value
                console.log(couponCode);
                $.ajax({
                    url: '/couponVerify/',
                    method: 'GET',
                    data: {
                        couponCode: couponCode
                    },

                    success: (response) => {
                        if (response.status == true) {

                            $.ajax({
                        
                                url: '/applyCoupon/' ,
                                method: 'GET',
                                data:{
                                    couponCode:couponCode,
                                    subTotal:total

                                },
                                success: (response) => {
                                    console.log(response);
                                    if (response.status == true) {
                                        document.getElementById('couponErr').style.color = '#19ff11'
                                        document.getElementById('couponErr').innerText = "Coupon Applied SuccessFully"
                                        // document.getElementById('subTotal').innerText = total - response.discountAmount
                                        document.getElementById('total').innerText = '₹' + Math.floor(total - response.discountAmount)
                                        document.getElementById('totalVal').value = Math.floor(total - response.discountAmount)
                                        document.getElementById('couponOffer').innerText = response.discount + '%'
                                        document.getElementById('discountPercentage').value = response.discount
                                        document.getElementById('discountAmount').value = Math.ceil(response.discountAmount)


                                    } else {
                                        document.getElementById('couponErr').style.color = "#ff0707"
                                        document.getElementById('couponErr').innerText = response.message
                                    }

                                }
                            })
                        } else {
                            document.getElementById('couponErr').style.color = "#ff0707"
                            document.getElementById('couponErr').innerText = response.message

                            setTimeout(function () {
                                location.reload()
                            }, 5000)
                        }

                    }
                })
            }



            // clear coupon

            function clearCoupon() {
        document.getElementById("couponCode").value = ""; 
        document.getElementById("total").innerText = "₹" + <%= cart.subTotal %>;
        document.getElementById("couponOffer").innerText = "";

        
        document.getElementById("couponErr").innerText = "";



     
    }








    
</script>








      

        <!-- address form validation -->

        
        
        
        
        
        






</body>

</html>